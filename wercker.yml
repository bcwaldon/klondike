#
# Copyright 2016 Planet Labs
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
journalbeat-build:
  box: golang:1.6.2
  steps:
    - wercker/setup-go-workspace:
        package-dir: github.com/bcwaldon/klondike

    - script:
        name: install systemd dependencies
        code: apt-get update && apt-get install -y pkg-config libsystemd-dev

    - script:
        cwd: src/journalbeat/
        name: go build
        code: ./build

    - script:
        cwd: src/journalbeat/
        name: save artifacts
        code: |
          cp bin/linux_amd64/* "$WERCKER_OUTPUT_DIR"
          cp docker/* "$WERCKER_OUTPUT_DIR"

journalbeat-deploy:
  box: golang:1.6.2
  steps:
  - internal/docker-push:
      username: $QUAY_USERNAME
      password: $QUAY_PASSWORD
      working-dir: /pipeline/source/
      tag: $WERCKER_GIT_COMMIT
      repository: quay.io/bcwaldon/journalbeat
      registry: https://quay.io
      cmd: ./run.sh

farva-build:
  box: golang
  steps:
    - wercker/setup-go-workspace:
        package-dir: github.com/bcwaldon/klondike

    - script:
        cwd: src/farva/
        name: go test
        code: ./test

    - script:
        cwd: src/farva/
        name: go build
        code: ./build

    - script:
        cwd: src/farva/
        name: copy binaries
        code: cp bin/linux_amd64/* "$WERCKER_OUTPUT_DIR"

farva-deploy:
    box: nginx:1.10.0
    steps:
    - internal/docker-push:
        username: $QUAY_USERNAME
        password: $QUAY_PASSWORD
        working-dir: /pipeline/source/
        tag: $WERCKER_GIT_COMMIT
        repository: quay.io/bcwaldon/farva
        registry: https://quay.io

kube-datadog-build:
  box: golang
  steps:
    - wercker/setup-go-workspace:
        package-dir: github.com/bcwaldon/klondike

    - script:
        cwd: src/kube-datadog/
        name: go test
        code: ./test

    - script:
        cwd: src/kube-datadog/
        name: go build
        code: ./build

    - script:
        cwd: src/kube-datadog/
        name: copy binary
        code: cp bin/linux_amd64/kube-datadog "$WERCKER_OUTPUT_DIR"

kube-datadog-deploy:
    box: golang
    steps:
    - internal/docker-scratch-push:
        username: $QUAY_USERNAME
        password: $QUAY_PASSWORD
        cmd: /kube-datadog
        tag: $WERCKER_GIT_COMMIT
        repository: quay.io/bcwaldon/kube-datadog
        registry: https://quay.io
