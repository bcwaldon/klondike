#
# Copyright 2016 Planet Labs
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
- set_fact:
    deploy_key_file: "{{ cluster_dir}}/id_rsa"

- name: check for SSH key
  stat: path={{ deploy_key_file }}
  register: cmd

- name: generate SSH key
  shell: "ssh-keygen -b 2048 -t rsa  -f {{ deploy_key_file }}  -N \"\" -C \"klondike deploy key for cluster {{ cluster }}\""
  when: not cmd.stat.exists

- name: read SSH key
  command: "cat {{ deploy_key_file }}.pub"
  register: shell

- set_fact:
    deploy_key: "{{ shell.stdout }}"

- name: Identify git version
  command: "{{ item }}"
  with_items:
  - bash ./roles/configure/files/git-tag.sh
  register: version

- name: render templated files
  template: src={{ item.src }} dest={{ cluster_dir }}/{{ item.dest }} mode={{ item.mode }}
  with_items:
  - { src: "ssh_config.j2", dest: "ssh_config", mode: "0644" }
  - { src: "ansible.cfg.j2", dest: "ansible.cfg", mode: "0644"}
  - { src: "ec2.ini.j2", dest: "ec2.ini", mode: "0644"}
  - { src: "cloud-config.yml.j2", dest: "cloud-config.yml", mode: "0644"}
  - { src: "bastion-cloud-config.yml.j2", dest: "bastion-cloud-config.yml", mode: "0644"}
  - { src: "create-stack.sh.j2", dest: "create-stack.sh", mode: "0755"}
  - { src: "kubeconfig.j2", dest: "kubeconfig", mode: "0644"}

- name: copy static files
  copy: src={{ item.src }} dest={{ cluster_dir }}/{{ item.dest }} mode={{ item.mode }}
  with_items:
  - { src: "ec2-inventory.py", dest: "inventory", mode: "0755"}
  - { src: "stack-template.json", dest: "stack-template.json", mode: "0644"}

