apiVersion: v1
kind: Pod
metadata:
  name: etcd-peer
  namespace: kube-system
spec:
  hostNetwork: true
  containers:
  - name: etcd
    image: quay.io/coreos/etcd:v2.3.0
    env:
    - name: ETCD_NAME
      value: "{{ inventory_hostname }}"
    - name: ETCD_DATA_DIR
      value: /var/lib/etcd/
    - name: ETCD_LISTEN_CLIENT_URLS
      value: http://{{ internal_ip }}:2379
    - name: ETCD_ADVERTISE_CLIENT_URLS
      value: http://{{ internal_ip }}:2379
    - name: ETCD_LISTEN_PEER_URLS
      value: http://{{ internal_ip }}:2380
    - name: ETCD_INITIAL_ADVERTISE_PEER_URLS
      value: http://{{ internal_ip }}:2380
    - name: ETCD_INITIAL_CLUSTER
      value: {% for host in groups['tag_group_controller'] %}
{{ hostvars[host]['inventory_hostname'] }}=http://{{ hostvars[host]['internal_ip'] }}:2380{% if not loop.last %},{% endif %}
{% endfor %}

    ports: 
    - containerPort: 2379
      hostPort: 2379
      name: api
    - containerPort: 2380
      hostPort: 2380
      name: raft

    volumeMounts:
    - mountPath: /var/lib/etcd
      name: etcd-data

  volumes:
  - name: etcd-data
    hostPath:
      path: /var/lib/etcd
